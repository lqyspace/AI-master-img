[toc]

# 灰度发布设计与实践

![image-20240914163210689](https://gcore.jsdelivr.net/gh/lqyspace/AI-master-img@master/img/202409141632658.png)

![image-20240914163521549](https://cdn.jsdelivr.net/gh/lqyspace/AI-master-img@master/img/202409141635661.png)

## 灰度发布系统协议设计

> **数据协议**

- 定长Header

  ```json
  {
      uid,
      token,
      IP,
      tag,
      mtest, // 全链路压测使用
      cmd,
      sessionID,
      bodyLen
  }
  ```

- 变长Body

  ```json
  {
      实际传输的内容
  }
  ```

- 设计初确定灰度发布字段

  - uid
  - Token
  - IP
  - Tag

> **灰度发布策略**

- 单策略

  - uid/token/IP

    假设对uid%100取模，得到的值可以决定是否进行灰度发布

- 基于上下文灰度策略

  - 多个模块A/C同时灰度
  - tag

![image-20240914172642655](https://cdn.jsdelivr.net/gh/lqyspace/AI-master-img@master/img/202409141726768.png)

![image-20240919101510871](https://cdn.jsdelivr.net/gh/lqyspace/AI-master-img@master/img/202409191015550.png)

![image-20240919102429393](https://cdn.jsdelivr.net/gh/lqyspace/AI-master-img@master/img/202409191024467.png)

MQ是如何去掉的？

数据到了数据访问层以后，可以把数据在本地缓存拷贝一份，让MQ去读数据，然后让MQ将数据转发的新版数据访问层；而在去掉MQ时，需要修改**业务逻辑层**的代码，使数据直新版数据访问层。

![image-20240919103033820](https://cdn.jsdelivr.net/gh/lqyspace/AI-master-img@master/img/202409191030898.png)

![image-20240919103156162](https://gcore.jsdelivr.net/gh/lqyspace/AI-master-img@master/img/202409191031239.png)

